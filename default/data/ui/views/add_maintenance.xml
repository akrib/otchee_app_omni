<form version="1.1" theme="light" script="common\assets\js\step_wizard_control\step_wizard_control_v2.js,common\assets\js\modal_popup\modal_popup.js,omni/omni.js" hideEdit="true">
  <label>ITSI : Add Maintenance_v2</label>
  <init>
    <set token="toast_message">information incomplete</set>
    <unset token="service_selected"></unset>
    <unset token="kpi_selected"></unset>
    <unset token="entity_selected"></unset>
    <!--<unset token="service_select_input_type"></unset>-->
    <set token="hide">1</set>
    <!--<eval token="email">$env:user_email$</eval>-->
    <!--<eval token="form.email">$env:user_email$</eval>-->
  </init>
  <search id="base_service">
    <query>
| rest splunk_server=local /servicesNS/nobody/SA-ITOA/itoa_interface/service report_as=text 
| spath input=value path={} output=svcs 
| stats count by svcs
| spath input=svcs path=title output=service_title 
| spath input=svcs path=kpis{} output=kpi 
| stats values(service_title) as service_title by kpi
| spath input=kpi path=_key output=search_id 
| spath input=kpi path=service_id output=service_id 
| fields service_title service_id
| table *
    </query>
  </search>
  <search id="base_kpi">
    <query>
| rest splunk_server=local /servicesNS/nobody/SA-ITOA/itoa_interface/service report_as=text 
| spath input=value path={} output=svcs 
| stats count by svcs
| fromjson svcs
| eval service_data=replace("$service_selected$","\*","%"), service_data=split(lower(service_data),";"),valid=0, valid=mvmap(service_data,valid+if(lower(title) LIKE(service_data),1,0)), valid=sum(valid)
| where valid&gt;0
| stats count by kpis
| spath input=kpis path=title output=kpi_title
| table kpi_title
      </query>
  </search>
  <search id="base_entity">
    <query>   
| rest splunk_server=local /servicesNS/nobody/SA-ITOA/itoa_interface/entity report_as=text 
| eval value=spath(value,"{}") 
| stats count by value 
| fromjson value 
| spath input=services path=title output=service_title 
| eval service_data=replace("$service_selected$","\*","%"), service_data=split(lower(service_data),";"),valid=0, valid=mvmap(service_data,valid+if(lower(service_title) LIKE(service_data),1,0)), valid=sum(valid)
| where valid&gt;0
| rename entity_name as entity_title
    </query>
  </search>
  <fieldset submitButton="false"></fieldset>
  <row>
    <panel>
      <html>
        <section class="navbar custom-navbar" role="navigation">
          <div class="container">
               <div class="navbar-header">
                    <h1 class="navbar-brand" style="font-size: 30px !important;">
                <span class="omni-title-first-part">
                  <img src="/static/app/otchee_app_omni/media/logo_omni.png" alt="Omni Logo" style="width: 200px; height: auto;"/>
                </span>
                <span class="omni-title-second-part"> Add Maintenance</span>
              </h1>
               </div>
          </div>
     </section>
        </html>
    </panel>
    <panel>
      <html>
       <div id="step_control_wizard_holder"/>
           <p id="swc_step_0" data-label="Service" data-value="" data-showPreviousButton="0" data-validateToken="service_selected"/>  
           <p id="swc_step_1" data-label="KPI" data-validateToken="kpi_selected"/>    
           <p id="swc_step_2" data-label="Entity" data-validateToken="entity_selected"/>
           <p id="swc_step_3" data-label="Periode" data-validateToken="periode_selected" data-showNextButton="false"/>    
           <!--<p id="swc_step_4" data-label="Validation" data-showNextButton="false" data-showDoneButton="true" data-doneLabel="Terminé"/>-->
        <div id="step-control-wizard"/>
        </html>
    </panel>
  </row>
  <row depends="$step_0$">
    <panel>
      <html>
        <h1>SERVICE</h1>
      </html>
    </panel>
  </row>
  <row depends="$step_0$">
    <panel>
      <input type="dropdown" token="service_select_input_type">
        <label>Type de sélection</label>
        <choice value="1">All</choice>
        <choice value="2">List</choice>
        <choice value="3">Wildcard</choice>
        <change>
          <condition value="1">
            <set token="service_type">1</set>
            <unset token="service_selected"></unset>
            <unset token="service_select_dual"></unset>
            <unset token="service_select_rex"></unset>
            <!-- Pour "All", on définit directement calculated -->
            <set token="service_calculated">%</set>
          </condition>
          <condition value="2">
            <set token="service_type">2</set>
            <unset token="service_selected"></unset>
            <unset token="service_calculated"></unset>
            <set token="service_select_dual">1</set>
            <unset token="service_select_rex"></unset>
          </condition>
          <condition value="3">
            <set token="service_type">3</set>
            <unset token="service_selected"></unset>
            <unset token="service_calculated"></unset>
            <unset token="service_select_dual"></unset>
            <set token="service_select_rex">1</set>
          </condition>
        </change>
      </input>
    </panel>
  </row>
  <row depends="$step_0$,$service_select_dual$" rejects="$service_loaded$">
    <panel>
      <html>
<div class="loader container">
<div class="loader book">
  <figure class="loader page"/>
  <figure class="loader page"/>
  <figure class="loader page"/>
</div>
</div>
<h1 class="loader title">Chargement</h1>

    </html>
    </panel>
  </row>
  <row depends="$step_0$,$service_select_dual$,$service_loaded$">
    <panel>
      <input type="multiselect" token="service_concat">
        <label>Services</label>
        <fieldForLabel>service_title</fieldForLabel>
        <fieldForValue>service_title</fieldForValue>
        <search base="base_service">
          <query>
| table service_title 
| stats count as _count by service_title
        </query>
          <done>
            <set token="service_loaded">1</set>
          </done>
        </search>
        <delimiter>;</delimiter>
        <choice value="%">All</choice>
        <change>
          <set token="service_calculated">$value$</set>
        </change>
      </input>
    </panel>
  </row>
  <row depends="$step_0$,$service_select_rex$">
    <panel>
      <input type="text" token="service_text_selected">
        <label>Wildcard (ex: *prod*)</label>
        <change>
          <set token="service_calculated">$value$</set>
        </change>
      </input>
    </panel>
  </row>
  <row depends="$step_0$,$service_select_input_type$,$hide$">
    <panel>
      <title>DEBUG =&gt; service_selected : $service_selected$</title>
      <table>
        <title>service query</title>
        <search base="base_service">
          <query>
| rename service_title as List 
| eval show="$hide$"
| table List
          </query>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
    <panel>
      <table>
        <title>all service query $service_select_all$</title>
        <search id="service_validator">
          <query>
| makeresults
| eval type="$service_type$", 
       calculated="$service_calculated$",
       method=case(
         type=="1", "All",
         type=="2", "List",
         type=="3", "Wildcard",
         true(), "Non défini"
       ),
       is_valid=if(isnotnull(calculated) AND calculated!="", 1, 0)
| where is_valid=1
| fields calculated method type
    </query>
          <done>
            <condition match="'job.resultCount' == 1">
              <set token="service_selected">$result.calculated$</set>
            </condition>
            <condition>
              <unset token="service_selected"></unset>
            </condition>
          </done>
          <cancelled>
            <unset token="service_selected"></unset>
          </cancelled>
          <error>
            <unset token="service_selected"></unset>
          </error>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
  <row depends="$step_1$">
    <panel>
      <html>
        <h1>KPI</h1>
      </html>
    </panel>
  </row>
  <row depends="$step_1$">
    <panel>
      <input type="dropdown" token="kpi_select_input_type">
        <label>Type de sélection</label>
        <choice value="1">All</choice>
        <choice value="2">List</choice>
        <choice value="3">Wildcard</choice>
        <change>
          <condition value="1">
            <set token="kpi_type">1</set>
            <unset token="kpi_selected"></unset>
            <unset token="kpi_select_dual"></unset>
            <unset token="kpi_select_rex"></unset>
            <!-- Pour "All", on définit directement calculated -->
            <set token="kpi_calculated">%</set>
          </condition>
          <condition value="2">
            <set token="kpi_type">2</set>
            <unset token="kpi_selected"></unset>
            <unset token="kpi_calculated"></unset>
            <set token="kpi_select_dual">1</set>
            <unset token="kpi_select_rex"></unset>
          </condition>
          <condition value="3">
            <set token="kpi_type">3</set>
            <unset token="kpi_selected"></unset>
            <unset token="kpi_calculated"></unset>
            <unset token="kpi_select_dual"></unset>
            <set token="kpi_select_rex">1</set>
          </condition>
        </change>
      </input>
    </panel>
  </row>
  <row depends="$step_1$,$kpi_select_dual$" rejects="$kpi_loaded$">
    <panel>
      <html>
<div class="loader container">
<div class="loader book">
  <figure class="loader page"/>
  <figure class="loader page"/>
  <figure class="loader page"/>
</div>
</div>
<h1 class="loader title">Chargement</h1>

    </html>
    </panel>
  </row>
  <row depends="$step_1$,$kpi_select_dual$,$kpi_loaded$">
    <panel>
      <input type="multiselect" token="kpi_concat">
        <label>kpis</label>
        <fieldForLabel>kpi_title</fieldForLabel>
        <fieldForValue>kpi_title</fieldForValue>
        <search base="base_kpi">
          <query>
| table kpi_title 
| stats count as _count by kpi_title
        </query>
          <done>
            <set token="kpi_loaded">1</set>
          </done>
        </search>
        <delimiter>;</delimiter>
        <choice value="%">All</choice>
        <change>
          <set token="kpi_calculated">$value$</set>
        </change>
      </input>
    </panel>
  </row>
  <row depends="$step_1$,$kpi_select_rex$">
    <panel>
      <input type="text" token="kpi_text_selected">
        <label>Wildcard (ex: *prod*)</label>
        <change>
          <set token="kpi_calculated">$value$</set>
        </change>
      </input>
    </panel>
  </row>
  <row depends="$step_1$,$kpi_select_input_type$,$hide$">
    <panel>
      <title>DEBUG =&gt; kpi_selected : $kpi_selected$</title>
      <table>
        <title>kpi query</title>
        <search base="base_kpi">
          <query>
| rename kpi_title as List 
| eval show="$hide$"
| table List
          </query>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
    <panel>
      <table>
        <title>all kpi query $kpi_select_all$</title>
        <search id="kpi_validator">
          <query>
| makeresults
| eval type="$kpi_type$", 
       calculated="$kpi_calculated$",
       method=case(
         type=="1", "All",
         type=="2", "List",
         type=="3", "Wildcard",
         true(), "Non défini"
       ),
       is_valid=if(isnotnull(calculated) AND calculated!="", 1, 0)
| where is_valid=1
| fields calculated method type
    </query>
          <done>
            <condition match="'job.resultCount' == 1">
              <set token="kpi_selected">$result.calculated$</set>
            </condition>
            <condition>
              <unset token="kpi_selected"></unset>
            </condition>
          </done>
          <cancelled>
            <unset token="kpi_selected"></unset>
          </cancelled>
          <error>
            <unset token="kpi_selected"></unset>
          </error>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
  <row depends="$step_2$">
    <panel>
      <html>
        <h1>ENTITY</h1>
      </html>
    </panel>
  </row>
  <row depends="$step_2$">
    <panel>
      <input type="dropdown" token="entity_select_input_type">
        <label>Type de sélection</label>
        <choice value="1">All</choice>
        <choice value="2">List</choice>
        <choice value="3">Wildcard</choice>
        <change>
          <condition value="1">
            <set token="entity_type">1</set>
            <unset token="entity_selected"></unset>
            <unset token="entity_select_dual"></unset>
            <unset token="entity_select_rex"></unset>
            <!-- Pour "All", on définit directement calculated -->
            <set token="entity_calculated">%</set>
          </condition>
          <condition value="2">
            <set token="entity_type">2</set>
            <unset token="entity_selected"></unset>
            <unset token="entity_calculated"></unset>
            <set token="entity_select_dual">1</set>
            <unset token="entity_select_rex"></unset>
          </condition>
          <condition value="3">
            <set token="entity_type">3</set>
            <unset token="entity_selected"></unset>
            <unset token="entity_calculated"></unset>
            <unset token="entity_select_dual"></unset>
            <set token="entity_select_rex">1</set>
          </condition>
        </change>
      </input>
    </panel>
  </row>
  <row depends="$step_2$,$entity_select_dual$" rejects="$entity_loaded$">
    <panel>
      <html>
<div class="loader container">
<div class="loader book">
  <figure class="loader page"/>
  <figure class="loader page"/>
  <figure class="loader page"/>
</div>
</div>
<h1 class="loader title">Chargement</h1>

    </html>
    </panel>
  </row>
  <row depends="$step_2$,$entity_select_dual$,$entity_loaded$">
    <panel>
      <input type="multiselect" token="entity_concat">
        <label>entitys</label>
        <fieldForLabel>entity_title</fieldForLabel>
        <fieldForValue>entity_title</fieldForValue>
        <search base="base_entity">
          <query>
| table entity_title 
| stats count as _count by entity_title
        </query>
          <done>
            <set token="entity_loaded">1</set>
          </done>
        </search>
        <delimiter>;</delimiter>
        <choice value="%">All</choice>
        <change>
          <set token="entity_calculated">$value$</set>
        </change>
      </input>
    </panel>
  </row>
  <row depends="$step_2$,$entity_select_rex$">
    <panel>
      <input type="text" token="entity_text_selected">
        <label>Wildcard (ex: *prod*)</label>
        <change>
          <set token="entity_calculated">$value$</set>
        </change>
      </input>
    </panel>
  </row>
  <row depends="$step_2$,$entity_select_input_type$,$hide$">
    <panel>
      <title>DEBUG =&gt; entity_selected : $entity_selected$</title>
      <table>
        <title>entity query</title>
        <search base="base_entity">
          <query>
| rename entity_title as List 
| eval show="$hide$"
| table List
          </query>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
    <panel>
      <table>
        <title>all entity query $entity_select_all$</title>
        <search id="entity_validator">
          <query>
| makeresults
| eval type="$entity_type$", 
       calculated="$entity_calculated$",
       method=case(
         type=="1", "All",
         type=="2", "List",
         type=="3", "Wildcard",
         true(), "Non défini"
       ),
       is_valid=if(isnotnull(calculated) AND calculated!="", 1, 0)
| where is_valid=1
| fields calculated method type
    </query>
          <done>
            <condition match="'job.resultCount' == 1">
              <set token="entity_selected">$result.calculated$</set>
            </condition>
            <condition>
              <unset token="entity_selected"></unset>
            </condition>
          </done>
          <cancelled>
            <unset token="entity_selected"></unset>
          </cancelled>
          <error>
            <unset token="entity_selected"></unset>
          </error>
        </search>
        <option name="drilldown">none</option>
      </table>
    </panel>
  </row>
  <row depends="$step_3$">
    <panel>
      <html>
        <center>
          <div id="downtime"/>
        </center>
      </html>
    </panel>
  </row>
  <row depends="$step_3$">
    <panel>
      <input type="checkbox" token="sendingEmail">
        <label></label>
        <choice value="1">Cocher pour envoyer un email recapitulatif</choice>
      </input>
      <input type="text" token="email" depends="$sendingEmail$">
        <label>Adresse Email du destinataire</label>
        <default>$env:user_email$</default>
        <initialValue>$env:user_email$</initialValue>
      </input>
    </panel>
  </row>
  <row depends="$hide_style$">
    <panel>
      <html>
        <table border="1" text-align="center">
          <tr>
            <td>dashboardType</td>
            <td>
              <div id="dashboardType">add</div>
            </td>
          </tr>
          <tr>
            <td>debug_mod (0 = off; 1 = on)</td>
            <td>
              <div id="debug">0</div>
            </td>
          </tr>
        </table>
      </html>
    </panel>
    <panel>
      <html>
        <a href="#modalpopup" rel="modal_popup:open" id="modal_link" style="visibility=hidden;"/>
        <div id="modalpopup" class="modal_popup">
          <table>
            <tr>
              <div id="modal_header"/>
            </tr>
            <tr>
              <div id="modal_content"/>
            </tr>
            <tr>
              <div id="modal_footer"/>
            </tr>
          </table>
        </div>
<style>
* {
  box-sizing: border-box;
}

body {
  background: #1977cc;
}

.loader h1 {
  color: #FFFFFF;
  text-align: center;
  font-family: sans-serif;
  text-transform: uppercase;
  font-size: 20px;
  position: relative;
}

.loader h1:after {
  position: absolute;
  content: "";
  -webkit-animation: Dots 2s cubic-bezier(0, .39, 1, .68) infinite;
  animation: Dots 2s cubic-bezier(0, .39, 1, .68) infinite;
}

.loader {
  margin: 1% auto 0px;
}

.loader.container{
width: 200px;
height: 100px;
background: #274685;
}

.loader.container:before{
padding:10px;
}

.book {
  border: 4px solid #FFFFFF;
  width: 60px;
  height: 45px;
  position: relative;
  perspective: 150px;
}

.loader.page {
  display: block;
  width: 30px;
  height: 45px;
  border: 4px solid #FFFFFF;
  border-left: 1px solid #274685;
  margin: 0;
  position: absolute;
  right: -4px;
  top: -4px;
  overflow: hidden;
  background: #274685;
  transform-style: preserve-3d;
  -webkit-transform-origin: left center;
  transform-origin: left center;
}

.book .page:nth-child(1) {
  -webkit-animation: pageTurn 1.2s cubic-bezier(0, .39, 1, .68) 1.6s infinite;
  animation: pageTurn 1.2s cubic-bezier(0, .39, 1, .68) 1.6s infinite;
}

.book .page:nth-child(2) {
  -webkit-animation: pageTurn 1.2s cubic-bezier(0, .39, 1, .68) 1.45s infinite;
  animation: pageTurn 1.2s cubic-bezier(0, .39, 1, .68) 1.45s infinite;
}

.book .page:nth-child(3) {
  -webkit-animation: pageTurn 1.2s cubic-bezier(0, .39, 1, .68) 1.2s infinite;
  animation: pageTurn 1.2s cubic-bezier(0, .39, 1, .68) 1.2s infinite;
}
.loader.title{
 color: #3c444d;
 text-align:center;
}


/* Page turn */

@-webkit-keyframes pageTurn {
  0% {
    -webkit-transform: rotateY( 0deg);
    transform: rotateY( 0deg);
  }
  20% {
    background: #1977cc;
  }
  40% {
    background: #1977cc;
    -webkit-transform: rotateY( -180deg);
    transform: rotateY( -180deg);
  }
  100% {
    background: #1977cc;
    -webkit-transform: rotateY( -180deg);
    transform: rotateY( -180deg);
  }
}

@keyframes pageTurn {
  0% {
    transform: rotateY( 0deg);
  }
  20% {
    background: #1977cc;
  }
  40% {
    background: #1977cc;
    transform: rotateY( -180deg);
  }
  100% {
    background: #1977cc;
    transform: rotateY( -180deg);
  }
}


/* Dots */

@-webkit-keyframes Dots {
  0% {
    content: "";
  }
  33% {
    content: ".";
  }
  66% {
    content: "..";
  }
  100% {
    content: "...";
  }
}

@keyframes Dots {
  0% {
    content: "";
  }
  33% {
    content: ".";
  }
  66% {
    content: "..";
  }
  100% {
    content: "...";
  }
}

.splunk-multidropdown{
width:800px;
height:300px;
background:#e1e6eb;
}

.splunk-multidropdown [class^="BoxStyles__Styled-"]{
width:800px !important;
height:300px !important;
background:#e1e6eb !important;
}
.splunk-multidropdown [class^="BoxStyles__Styled-"] [class^="ClickableStyles__StyledA-"]{
background:#fff !important;
background-color:#fff !important;
color:#000 !important;
}

.add.square.icon:before{
left:40px;
content:"➕";
}
.add.square.icon{
width:40px;
padding:10px
}


</style>
      </html>
    </panel>
  </row>
</form>
